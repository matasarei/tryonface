<!doctype html>
<html lang="en">
<head>
    <title>Camera Project</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: monospace;
            font-size: 11px;
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            /* Mirror horizontally for a natural camera preview */
            transform: scaleX(-1);
        }

        #camera {
            /* Mirror horizontally for a natural camera preview */
            transform: scaleX(-1);
            border: 1px black dotted;
        }

        #tryon {
            position: relative;
            margin: 0 auto;
        }

        #start {
            margin:0 auto;
            width:100px;
            display: block;
        }

        #debug {
            width: 640px;
            margin: 0 auto;
            line-height: 12px;
        }

        #hint {
            color: #0044aa;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
<!-- MediaPipe Face Mesh and Camera Utils from CDN -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<div id="tryon">
    <video id="camera" loop></video>
    <canvas id="overlay"></canvas>
</div>
<button id="start">Start</button>
<div id="debug"></div>
<div id="hint">Turn your face towards the camera and move your head to adjust the glasses position.</div>

<script type="module">
    import { TryOnFace } from './js/tryon-face.js';

    const startButton = document.getElementById('start');
    startButton.style.display = 'none';
    const debugDiv = document.getElementById('debug');

    const object = {
        outside: {
            left: './glasses/left.png',
            right: './glasses/right.png',
            front: './glasses/front.png'
        }
    };

    let tryOn = null;
    let debugInterval = null;

    function safeFixed(val, digits = 1) {
        return (typeof val === 'number' && isFinite(val)) ? val.toFixed(digits) : 'N/A';
    }

    function updateDebug() {
        if (!tryOn) return;
        const status = tryOn.getStatus();
        const params = tryOn.getParameters();
        debugDiv.innerHTML = `<strong>Status:</strong> ${status}<br>`
            + `<strong>Position:</strong> x=${safeFixed(params.position.x)}, y=${safeFixed(params.position.y)}, z=${safeFixed(params.position.z)}<br>`
            + `<strong>Rotation:</strong> y=${safeFixed(params.rotation.y, 3)}, z=${safeFixed(params.rotation.z, 3)}<br>`
            + `<strong>Size:</strong> x=${safeFixed(params.size.x)}, y=${safeFixed(params.size.y)}, z=${safeFixed(params.size.z)}`;
    }

    window.addEventListener('load', function() {
        tryOn = new TryOnFace({
            width: 640,
            height: 480,
            object: object,
            statusHandler: function(status) {
                switch(status) {
                    case "STATUS_READY": {
                        startButton.style.display = 'block';
                        startButton.textContent = 'Start';
                    } break;
                    case "STATUS_CAMERA_ERROR": {
                        alert('Camera error. Please allow camera access.');
                    } break;
                    case "STATUS_SEARCH": {
                        /* Searching for face */
                    } break;
                    case "STATUS_FOUND": {
                        /* Face found and tracking */
                    }
                }
            }
        });

        startButton.addEventListener('click', function() {
            if (!tryOn) return;
            if (tryOn.stream) {
                tryOn.stop();
                clearInterval(debugInterval);
                updateDebug();
                startButton.textContent = 'Start';
            } else {
                tryOn.start();
                debugInterval = setInterval(updateDebug, 250);
                startButton.textContent = 'Stop';
            }
        });

        updateDebug();
    });
</script>
</body>
</html>
